import{_ as i,c as e,o as a,a2 as t}from"./chunks/framework.CAeRsQAW.js";const c=JSON.parse('{"title":"Basic Understanding","description":"Get a basic understanding on how to the QuickJS module works","frontmatter":{"title":"Basic Understanding","description":"Get a basic understanding on how to the QuickJS module works","order":10},"headers":[],"relativePath":"docs/basic-understanding.md","filePath":"docs/basic-understanding.md","lastUpdated":1741470167000}'),n={name:"docs/basic-understanding.md"};function h(l,s,o,r,p,d){return a(),e("div",null,s[0]||(s[0]=[t(`<h1 id="basic-understanding" tabindex="-1">Basic Understanding <a class="header-anchor" href="#basic-understanding" aria-label="Permalink to ‚ÄúBasic Understanding‚Äù">‚Äã</a></h1><p>This documentation provides essential information to help you avoid common pitfalls when working with QuickJS WebAssembly runtime. The terms &quot;host&quot; and &quot;guest&quot; are used to describe your main application and the QuickJS runtime, respectively.</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>As the QuickJS sandbox is running via WebAssembly, the JavaScript eventloop gets blocked by the WebAssembly execution.</p></div><h2 id="synchronous-execution" tabindex="-1">Synchronous Execution <a class="header-anchor" href="#synchronous-execution" aria-label="Permalink to ‚ÄúSynchronous Execution‚Äù">‚Äã</a></h2><h3 id="üö´-blocking-the-javascript-event-loop" tabindex="-1">üö´ Blocking the JavaScript Event Loop <a class="header-anchor" href="#üö´-blocking-the-javascript-event-loop" aria-label="Permalink to ‚Äúüö´ Blocking the JavaScript Event Loop‚Äù">‚Äã</a></h3><p>When the <code>evalCode</code> method is called on the host, the event loop of the host system is blocked until the method returns.</p><p>Here is an example of how the host system can be blocked üî•:</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { loadQuickJs } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@sebastianwessel/quickjs&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">runSandboxed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> loadQuickJs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setInterval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;y&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;start&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> code</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> \`</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">const fn = () =&gt; new Promise(() =&gt; {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  while(true) {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">})</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">export default await fn()</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> result</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> runSandboxed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">evalCode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> evalCode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(code))</span></span></code></pre></div><p>You might expect that this code does not block the host system, but it does, even with <code>await evalCode</code>. The host system must wait for the guest system to return a value. In this example, the value is never returned because of the endless while-loop.</p><h3 id="‚è≥-setting-execution-timeouts" tabindex="-1">‚è≥ Setting Execution Timeouts <a class="header-anchor" href="#‚è≥-setting-execution-timeouts" aria-label="Permalink to ‚Äú‚è≥ Setting Execution Timeouts‚Äù">‚Äã</a></h3><p><strong>‚ùó Set Execution Timeouts if Possible</strong><br> It is highly recommended to set a default timeout value to avoid blocking the host system indefinitely. The execution timeout can be set in the options of <code>runSandboxed</code>. Setting the <code>executionTimeout</code> to <code>0</code> or <code>undefined</code> disables the execution timeout.</p><p>Timeout values are in milliseconds.</p><p><strong>Please see: <a href="./runtime-options.html">Runtime Options - Execution Limits</a></strong></p><h3 id="üë∑-workers-and-threads" tabindex="-1">üë∑ Workers and Threads <a class="header-anchor" href="#üë∑-workers-and-threads" aria-label="Permalink to ‚Äúüë∑ Workers and Threads‚Äù">‚Äã</a></h3><p>It is <strong>highly recommended</strong> to run the guest system in separate workers or threads rather than the main thread. This approach has several critical benefits:</p><ol><li>It ensures that the main event loop is not blocked.</li><li>Multiple workers can boost performance.</li><li>The host application can terminate a single worker anytime. If the guest system exceeds the maximum runtime, restarting the worker ensures a clean state.</li></ol><h2 id="asynchronous-behavior" tabindex="-1">Asynchronous Behavior <a class="header-anchor" href="#asynchronous-behavior" aria-label="Permalink to ‚ÄúAsynchronous Behavior‚Äù">‚Äã</a></h2><p>The provided QuickJS WebAssembly runtime does not have an internal event loop like a regular runtime. Instead, the host system must trigger the loop for any provided promises. This library starts an interval on the host that triggers <code>executePendingJobs</code> in QuickJS. The interval is automatically stopped and removed when no longer needed.</p><p>When a promise is provided by the host and used by the client, the client executes until it reaches the promise. If the promise is not settled, the QuickJS runtime pauses execution. Once the promise is settled, the host needs to call <code>executePendingJobs</code> to instruct QuickJS to resume execution.</p>`,19)]))}const u=i(n,[["render",h]]);export{c as __pageData,u as default};
